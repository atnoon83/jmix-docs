= FullCalendar data binding

In this section, you will create:

* `Meeting` JPA entity.
* `FullCalendar` component with event provider.

== Meeting event

`Meeting` entity will be an event in the `FullCalendar` component. It should have corresponding properties to be correctly displayed in the component:

- `name` - is the event title.
- `startDate` - the start date in the component. The component does not display events without a start date.
- `endDate` - the end date in the component. If the end date is not specified, the component will add a default time duration for the event depending on the allDay property. In this tutorial, the `allDay` property is not used, so the component considers the events as non-all-day events.

=== Create Meeting Entity

You can find detailed instructions for creating entities in the xref:tutorial:simple-crud.adoc[Simple CRUD] section of the Tutorial.

The `Meeting` entity has the following attributes:

* `name` with `String` type. Select the *Mandatory* checkbox.
* `startDate` with `LocalDateTime`. Select the *Mandatory* checkbox.
* `endDate` with `LocalDateTime`.
* `user` - has the `Association` attribute type, `User` entity as a Java type and the many-to-one cardinality. Select the *Mandatory* checkbox.

The `Meeting` entity does not have standard views: list and details, because it will be generated programmatically and displayed in the `FullCalendar` component.

=== Generate Meeting in My Onboarding view

When the employee completes all steps then the application should generate a meeting event to discuss completed tasks. And we'll display this event in "My Calendar" view.

The best moment to check whether the employee has finished all steps is during the xref:flow-ui:data/data-context.adoc#pre-save-event[PreSaveEvent] of xref:flow-ui:data/data-context.adoc[DataContext]. In the event listener, we should filter out all uncompleted steps. If the list is empty, we should generate an event.

[source, java, indent=0]
----
include::example$/fullcalendar-ex1/src/main/java/com/company/onboarding/view/myonboarding/MyOnboardingView.java[tags=onboarding-pre-save-event]
----

Next, we will implement the `generateOnboardingResultsMeeting()` method. This method should create an instance of the `Meeting` event that starts on the next working day.

[source, java, indent=0]
----
include::example$/fullcalendar-ex1/src/main/java/com/company/onboarding/view/myonboarding/MyOnboardingView.java[tags=onboarding-generate-meeting]
----
<1> Creates and merges a new `Meeting` instance into the `DataContext`. Thus, the meeting entity will be saved as well.
<2> Calculates the next working day. If today is Friday, then meeting should start on Monday.
<3> Creates the start date of meeting event. The meeting will start on the next working day at 9:30 AM.

== Add components on MyCalendar

Firstly, create a blank view and call it *My Calendar*.

image::creating-my-calendar-view.png[align="center"]

Studio will generate an empty view and display it in the designer.

=== Load Data

Before adding the `FullCalendar` component, let's add a xref:flow-ui:data/collection-container.adoc[collection container] of `Meeting` entity.

Click *Add Component* in the actions panel, in *Data components* section double-click on *Collection container*. In the appeared dialog select `Meeting` entity in *Entity* field and click *OK*.

[source, xml, indent=0]
----
include::example$fullcalendar-ex1/src/main/resources/com/company/onboarding/view/sampleone/sample-one.xml[tags=onboarding-add-fullcalendar2]
----

The current configuration of loader fetches all events from all users. However, the users must see only their own events. We will add a condition to filter events by current user. Modify the JPQL query using editor or manually:

[source, xml, indent=0]
----
include::example$fullcalendar-ex1/src/main/resources/com/company/onboarding/view/mycalendar/my-calendar.xml[tags=onboarding-add-fullcalendar3]
----

We will get the current user from `CurrentAuthentication` bean and pass it to the loader on xref:flow-ui:views/view-events.adoc#before-show-event[BeforeShowEvent]:

* Subscribe on `BeforeShowEvent`.
* Inject `meetingsDl` loader.
* Inject `CurrentAuthentication` bean.

Now we can set parameter to the loader in order to fetch events for the current user:

[source, java, indent=0]
----
include::example$fullcalendar-ex1/src/main/java/com/company/onboarding/view/mycalendar/MyCalendar.java[tags=onboarding-add-fullcalendar4]
----

=== Add FullCalendar

Click *Add Component* in the actions panel, find the `FullCalendar` item, and then double-click it.

Then new `calendar` element will be generated. Configure the `id`, `height` and `width` attributes as shown below.

[source, xml, indent=0]
----
include::example$fullcalendar-ex1/src/main/resources/com/company/onboarding/view/sampleone/sample-one.xml[tags=onboarding-add-fullcalendar1]
----

=== Add Event Provider

The event provider is a source of events displayed in the `FullCalendar`. There are different types of event providers, but we will use the event provider based on xref:flow-ui:data/data-containers.adoc[data container].

Add *ContainerEventProvider* to the `FullCalendar`. Select `calendar` in the *Jmix UI* structure panel or in the view XML descriptor, the click the *Add* button in the inspector panel. From the drop-down list, choose *Event providers* -> *ContainerEventProvider*.

image::add-container-event-provider.png[align="center"]

In the appeared dialog select `meetingsDc`.

The `containerEventProvider` element contains a set of properties that the user can specify to configure mapping of entity's properties. The `Meeting` entity has:

* `name`
* `startDate`
* `endDate`

So we should specify the following attributes:

[source, xml, indent=0]
----
include::example$fullcalendar-ex1/src/main/resources/com/company/onboarding/view/sampletwo/sample-two.xml[tags=onboarding-add-fullcalendar3]
----

Letâ€™s take a look: the complete description of our calendar is as follows:

[source, xml, indent=0]
----
include::example$fullcalendar-ex1/src/main/resources/com/company/onboarding/view/samplethree/sample-three.xml[tags=onboarding-add-fullcalendar4]
----

Launch the application and log in as `admin`. The `admin` user does not have onboarding steps, so we should generate them. Select the *Users* item in the application menu to access `User.list` view. Select `admin` in the *DataGrid* and click on *Edit* button.

// todo finish and check grammar and semantic